generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  name                String?
  phone               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  stripeCustomerId    String?  @map("stripe_customer_id")
  subscriptionTier    String?  @map("subscription_tier") // starter, professional, multi_location
  subscriptionStatus  String?  @map("subscription_status") // active, past_due, canceled, trialing
  
  businesses          Business[]
  renewalHistory      RenewalHistory[]
  
  @@map("users")
}

model Business {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  name          String
  businessType  String?  @map("business_type") // food_vendor, contractor, mobile_service, other
  address       String?
  city          String?
  state         String?
  zip           String?
  phone         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenses      License[]
  
  @@index([userId])
  @@map("businesses")
}

model License {
  id                String   @id @default(uuid())
  businessId        String   @map("business_id")
  licenseType       String   @map("license_type")
  licenseNumber     String?  @map("license_number")
  issuingAuthority  String   @map("issuing_authority")
  issueDate         DateTime @map("issue_date")
  expirationDate    DateTime @map("expiration_date")
  renewalUrl        String?  @map("renewal_url")
  status            String   @default("current") // current, expiring_soon, expired, grace_period
  gracePeriodDays   Int      @default(0) @map("grace_period_days")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  documents         Document[]
  reminderSchedules ReminderSchedule[]
  renewalHistory    RenewalHistory[]
  
  @@index([businessId])
  @@index([expirationDate])
  @@map("licenses")
}

model Document {
  id          String   @id @default(uuid())
  licenseId   String   @map("license_id")
  fileName    String   @map("file_name")
  fileUrl     String   @map("file_url")
  fileType    String   @map("file_type")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  
  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  @@index([licenseId])
  @@map("documents")
}

model ReminderSchedule {
  id                    String    @id @default(cuid())
  licenseId             String    @map("license_id")
  daysBeforeExpiration  Int       @map("days_before_expiration")
  reminderType          String    @map("reminder_type") // 'sms' | 'email' | 'both'
  sentAt                DateTime? @map("sent_at")
  status                String    @default("pending") // pending, sent, failed
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  license               License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  @@unique([licenseId, daysBeforeExpiration, reminderType]) // prevents duplicates
  @@index([licenseId])
  @@index([sentAt])
  @@map("reminder_schedules")
}

model JobRun {
  id        String   @id @default(cuid())
  jobName   String
  runDate   DateTime // use date-only semantics (UTC midnight) in code
  createdAt DateTime @default(now())

  @@unique([jobName, runDate])
  @@map("job_runs")
}

model RenewalHistory {
  id                      String   @id @default(uuid())
  licenseId               String   @map("license_id")
  renewedAt               DateTime @default(now()) @map("renewed_at")
  previousExpirationDate  DateTime @map("previous_expiration_date")
  newExpirationDate       DateTime @map("new_expiration_date")
  renewedBy               String   @map("renewed_by")
  notes                   String?
  
  license                 License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  user                    User     @relation(fields: [renewedBy], references: [id])
  
  @@index([licenseId])
  @@map("renewal_history")
}

model Jurisdiction {
  id                    String   @id @default(uuid())
  name                  String
  state                 String
  licenseTypes          String?  @map("license_types")
  renewalPortalUrls     String?  @map("renewal_portal_urls")
  typicalRequirements   String?  @map("typical_requirements")
  gracePeriods          String?  @map("grace_periods")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("jurisdictions")
}